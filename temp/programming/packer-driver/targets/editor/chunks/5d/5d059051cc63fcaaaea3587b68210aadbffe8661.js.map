{"version":3,"sources":["file:///Users/super_javan/cocoscreator/littleBeastFight3.6/assets/Battle/Script/UIBattle.ts"],"names":["_decorator","Node","Button","Component","EventMgr","LogicEvent","UIScreen","Config","MoveCardDTO","OpenCardDTO","FireKit","GameEngine","GameEvent","HumanPlayer","PlayerManager","TweenUtil","ccclass","property","UIBattle","type","_engine","cards","chairIds","_meChair","_meId","_meColor","_locked","fromIndex","INVALID_INDEX","_iconMapping","isEngross","openResultLogic","openResultVO","index","card","clearSelectStyle","updateOpenCard","updateAndSelectStyle","sitDownLogic","sitDownVO","chair","userId","onShow","params","init","eventRegister","enter","inst","create","use","HUMAN_FIRE","onGroup","SIT_DOWN","START_GAME","startGameLogic","OPEN_RESULT","startGameVo","console","log","node","btnCards","length","clickEventHandler","EventHandler","target","component","handler","customEventData","String","button","addComponent","clickEvents","push","callback","event","getComponent","row","Math","floor","col","color","DARK","open","canMove","move","cardTemp","getCardItemTemp","flip","updateStyle","i","element","Number","MAX_CARD","onBtnBackLobby","closeSelf","Instance","emit","ENTER_HALL_FROM_GAMES"],"mappings":"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","sourcesContent":["import { _decorator, Node, Button, Component, TiledUserNodeData } from \"cc\";\nimport EventMgr from \"../../Script/Base/EventMgr\";\nimport { LogicEvent } from \"../../Script/Games/LogicEvent\";\nimport { UIScreen } from \"../../Script/UIFrame/UIFrom\";\nimport Config from \"./games/Config\";\nimport MoveCardDTO from \"./games/dto/MoveCardDTO\";\nimport OpenCardDTO from \"./games/dto/OpenCardDTO\";\nimport FireKit from \"./games/fire/FireKit\";\nimport GameEngine from \"./games/GameEngine\";\nimport GameEvent from \"./games/GameEvent\";\nimport HumanPlayer from \"./games/HumanPlayer\";\nimport PlayerManager from \"./games/PlayerManager\";\nimport TweenUtil from \"./games/utils/TweenUtils\";\nimport OpenResultVO from \"./games/vo/OpenResultVO\";\nimport SitDownVO from \"./games/vo/SitDownVO\";\nimport StartGameVO from \"./games/vo/StartGameVO\";\n\nconst { ccclass, property } = _decorator;\n\n@ccclass('UIBattle')\nexport class UIBattle extends UIScreen {\n\n    /**\n     * 引擎\n     */\n    private _engine: GameEngine;\n    /**\n     * 当前牌面的牌\n     */\n    private cards: number[];\n    /**\n     * Chair -> ID\n     */\n    private chairIds: { [chair: number]: number } = {};\n    /**\n     * 自己的编号\n     */\n    private _meChair: number;\n    /**\n     * 自己的游戏ID\n     */\n    private _meId: number = 1001;\n    /**\n     * 颜色\n     */\n    private _meColor: number;\n    /**\n     * 锁定状态\n     */\n    private _locked: boolean = true;\n    /**\n     * 开始的位置\n     */\n    private fromIndex: number = GameEngine.INVALID_INDEX;\n\n    @property(Node)\n    UIGames: Node = null\n\n    private _iconMapping: { [key: number]: string; } = {\n        0x00: \"蓝鼠\",\n        0x01: \"蓝猫\",\n        0x02: \"蓝狗\",\n        0x03: \"蓝狼\",\n        0x04: \"蓝豹\",\n        0x05: \"蓝虎\",\n        0x06: \"蓝狮\",\n        0x07: \"蓝象\",\n        0x10: \"红鼠\",\n        0x11: \"红猫\",\n        0x12: \"红狗\",\n        0x13: \"红狼\",\n        0x14: \"红豹\",\n        0x15: \"红虎\",\n        0x16: \"红狮\",\n        0x17: \"红象\"\n    };\n    isEngross = false;\n\n    @property({ type: [Node] })\n    btnCards: Node[] = [];\n\n    async onShow(...params: any) {\n        this.init();\n        this.eventRegister();\n\n        this._engine.enter(PlayerManager.inst().create(new HumanPlayer(this._meId, \"鸡哥\")));// 进入游戏\n    }\n\n    init() {\n        this._engine = new GameEngine();\n    }\n\n    eventRegister() {\n        FireKit.use(Config.HUMAN_FIRE).onGroup(GameEvent.SIT_DOWN, this.sitDownLogic, this);\n        FireKit.use(Config.HUMAN_FIRE).onGroup(GameEvent.START_GAME, this.startGameLogic, this);\n        FireKit.use(Config.HUMAN_FIRE).onGroup(GameEvent.OPEN_RESULT, this.openResultLogic, this);\n        // FireKit.use(Config.HUMAN_FIRE).onGroup(GameEvent.CONFIRM_COLOR, this.confirmColorLogic, this);\n        // FireKit.use(Config.HUMAN_FIRE).onGroup(GameEvent.OPERATION_NOTIFY, this.operationNotifyLogic, this);\n        // FireKit.use(Config.HUMAN_FIRE).onGroup(GameEvent.MOVE_RESULT, this.moveResultLogic, this);\n        // FireKit.use(Config.HUMAN_FIRE).onGroup(GameEvent.END_GAME, this.endGameLogic, this);\n    }\n\n    startGameLogic(startGameVo: StartGameVO) {\n        console.log(this.node)\n        this.cards = startGameVo.cards;\n        this._locked = startGameVo.chair != this._meChair;\n        for (let index = 0; index < this.btnCards.length; index++) {\n            let clickEventHandler = new Component.EventHandler();\n            clickEventHandler.target = this.node;\n            clickEventHandler.component = 'UIBattle';\n            clickEventHandler.handler = 'callback';\n            clickEventHandler.customEventData = String(index);\n            let button = this.btnCards[index].addComponent(Button)\n            button.clickEvents.push(clickEventHandler);\n        }\n    }\n\n    callback(event, customEventData) {\n        let node = event.target;\n        let button = node.getComponent(Button);\n        let index = customEventData;\n        let row = Math.floor(index / 4);\n        let col = index % 4;\n        console.log('row:' + row + ',col:' + col);\n        console.log(this._locked)\n        if (!this._locked) {\n            let card = this.cards[index];\n            console.log('card:' + card);\n            let color = card >> 4;//判断花色\n            console.log('card >> 4' + color);\n\n            if (color === GameEngine.DARK) {\n                this._engine.open(new OpenCardDTO(this._meChair, index));\n            } else {\n                if (this.fromIndex == GameEngine.INVALID_INDEX) {\n                    if (color == this._meColor) {\n                        // 选中了自己添加选中状态\n                        this.updateAndSelectStyle(index);\n                        this.fromIndex = index;\n                    }\n                } else {\n                    if (this._engine.canMove(this.fromIndex, index, this.cards)) {\n                        this._engine.move(new MoveCardDTO(this._meChair, this.fromIndex, index));\n                        this.fromIndex = GameEngine.INVALID_INDEX;\n                        this.clearSelectStyle();    // 清除选中状态\n                    } else {\n                        //选中后 再切换到别的牌\n                        if (color == this._meColor) {\n                            this.updateAndSelectStyle(index);\n                            this.fromIndex = index;\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     *\n     * @param openResultVO\n     */\n    openResultLogic = (openResultVO: OpenResultVO) => {\n        this.cards[openResultVO.index] = openResultVO.card;\n        this.clearSelectStyle();\n        this.updateOpenCard(openResultVO);\n        this.updateAndSelectStyle(openResultVO.index);\n        this.fromIndex = GameEngine.INVALID_INDEX;\n    };\n    async updateOpenCard(openResultVO) {\n        let card = openResultVO.card;\n        let index = openResultVO.index;\n        let cardTemp = this.getCardItemTemp(index);\n\n        await TweenUtil.flip(cardTemp, 0.8, () => {\n            this.updateStyle(index, card);\n        });\n    }\n    getCardItemTemp(index: any) {\n        for (let i = 0; i < this.btnCards.length; i++) {\n            const element = this.btnCards[i];\n            if (i == Number(index))\n                return element;\n        }\n    }\n\n    /**\n     * 更新牌的样式\n     * @param index\n     */\n    private updateStyle(index, card) {\n        let cardTemp = this.getCardItemTemp(index);\n\n    }\n\n    /**\n     * 增加选择状态\n     * @param index\n     */\n    private updateAndSelectStyle(index: number) {\n        this.clearSelectStyle();            // 先清除选中\n\n    }\n\n    /**\n     * 清除选中状态\n     */\n    private clearSelectStyle() {\n        for (let i = 0; i < GameEngine.MAX_CARD; i++) {\n            // let gObject = this._view.getChild(\"card_\" + i);\n            // if (gObject != null) {\n            //     gObject.asCom.getChild(\"active\").asImage.visible = false;\n            // }\n        }\n    }\n\n    /**\n     *\n     * @param sitDownVO\n     */\n    sitDownLogic = (sitDownVO: SitDownVO) => {\n        this.chairIds[sitDownVO.chair] = sitDownVO.userId;\n        if (sitDownVO.userId == this._meId) {   //如果是自己\n            this._meChair = sitDownVO.chair;\n        }\n    };\n\n    async onBtnBackLobby() {\n        await this.closeSelf();\n        EventMgr.Instance.emit(LogicEvent.ENTER_HALL_FROM_GAMES);\n    }\n}"]}